This app is a GNU/LGPL toolbox for locating individual targets of non-invasive brain stimulation via revealing altered functional connectivity.

This app is based on SPM (https://www.fil.ion.ucl.ac.uk/spm/), DPABI (http://rfmri.org/DPABI), mni2cor (https://www.alivelearn.net/?p=1434), cor2mni (https://www.alivelearn.net/?p=1434), and cuixuFindStructure (https://www.alivelearn.net/?p=1456). Therefore, those toolboxes should be added to your Matlab path.

To use this app, add the directory containing this app to Matlab path first. Then this app could be opened and edited in App Designer on Matlab.

1.	estimate amygdala connectivity
The individual resting fMRI images should be placed in the individual folder under FunRAW (dicom) or FunImg (nifti) folder, while structural images in the individual folder under T1RAW (dicom) or T1Img (nifti). For instance, if you select ‘C:\WD’ as the working directory, then the functional and structural images of patient1 in dicom format should be placed in the following directory respectively:
‘C:\WD\FunRaw\patient1\’
‘C:\WD\T1Raw\patient1\’
or for nifti format: 
‘C:\WD\FunImg\patient1\’
‘C:\WD\T1Img\patient1\’

the process including:
(1)	dicom to nifti (optional)
(2)	remove first 10 time points
(3)	slice timing
(4)	reaglin
(5)	coregister
(6)	DARTEL segment and normalization
(7)	nuisance covariates regression
(8)	band filter
(9)	scrubbing
(10)	 calculate functional connectivity
(11)	 smooth

The default parameter was designed to estimate amygdala (AAL3 atlas) functional connectivity. Users can change the parameter by edit ‘amygdala_default.mat’ to estimate other functional connectivity.

2.	mask based on the depth of stimulation
Considering non-invasive brain stimulation cannot reach the deep structures of brain, we should remove those structures before calculate the altered connectivity we want to target at. We can select the results generated by the first step, which was stored in the ‘ResultsS’ folder, and the name of which begins with ‘szFCMap’. We can also select custom images generated by other toolboxes.

3.	find max differences
The targeted altered connectivity is defined as the region with the largest differences between the individual connectivity image and the norm images. The individual images could select the result image from the second step, the name of which begins with ‘depth_masked’. The default norm image is ‘mean_HCP_amygdala_AAL3_zFC.nii’, which was calculated with the parameter in the first step (except for not smoothing) using 1096 healthy young adults from the HCP project (https://www.humanconnectome.org/). The user can use custom individual and norm images, but should remember to reslice those images in order to make them structurally comparable.

Considering non-invasive brain stimulators are able to stimulate regions in certain distance near the electrode or coils, we need to define the min distance between targets and screen out those targets too near to each other. In addition, we need to select what kind of connectivity we are interested in, because different types of stimulation (positive or negative current, high or low frequency magnetic pulse, and etc.) will generate different changes in functional connectivity, and different connectivity might play different roles in brain functions.

4.	inverse normalization
The result image of stimulation target generated by the last step, the name of which begins with ‘max_’, is presented in normalized space. However, we want targets in individual space to locate the stimulator accurately. Therefore, we need to transform the image from normalized space back to individual space. In addition to selecting the image needed to be transformed, we also need to select the DARTEL flow file in nifti format, which is stored in the individual folder under ‘T1ImgNewSegment’ directory, and the name of which begins with ‘u’.


